<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿ v4.0 (ç·¨é›†ãƒ»éš™é–“å¯¾ç­–)</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; display: flex; gap: 20px; padding: 20px; background-color: #f4f7f6; height: 95vh; box-sizing: border-box; color: #333; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #canvas-wrapper { position: relative; border: 2px solid #ccc; overflow: auto; flex-grow: 1; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; }
        canvas { cursor: default; display: block; }
        
        #sidebar { width: 340px; display: flex; flex-direction: column; gap: 15px; height: 100%; min-width: 340px; }
        .panel { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        h3 { margin: 0 0 10px 0; font-size: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #555; }
        
        /* UIãƒ‘ãƒ¼ãƒ„ */
        input[type="text"], select, input[type="number"], input[type="range"] { padding: 8px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; margin-bottom: 8px;}
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; color: white; background: #007bff; width: 100%; margin-bottom: 5px;}
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.danger { background: #dc3545; }
        button.outline { background: transparent; border: 1px solid #007bff; color: #007bff; }
        button.outline:hover { background: #f0f8ff; }

        .input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .input-group button { width: auto; flex-grow: 1; margin: 0; }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– */
        .tabs { display: flex; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 8px; text-align: center; cursor: pointer; background: #f9f9f9; color: #666; border: 1px solid #ddd; border-bottom: none; margin-right: -1px;}
        .tab.active { background: white; color: #007bff; font-weight: bold; border-top: 2px solid #007bff; }

        /* ãƒªã‚¹ãƒˆ */
        .list-container { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; height: 150px; }
        .list-item { padding: 8px; border-bottom: 1px solid #f0f0f0; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #f5faff; }
        .list-item.selected { background: #e6f2ff; border-left: 4px solid #007bff; }

        .hidden { display: none; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 2px;}
        .slider-val { float: right; font-weight: normal;}
    </style>
</head>
<body>

    <div id="canvas-wrapper">
        <canvas id="mapCanvas"></canvas>
    </div>

    <div id="sidebar">
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ -->
        <div class="panel">
            <h3>1. å›³é¢èª­è¾¼</h3>
            <input type="file" id="imageLoader" accept="image/*, .svg">
        </div>

        <!-- ç·¨é›†ãƒ»ä½œæˆãƒ‘ãƒãƒ« -->
        <div class="panel" style="flex-grow: 1; display: flex; flex-direction: column;">
            <div class="tabs">
                <div class="tab active" onclick="setMode('magic')" id="tabMagic">ğŸª„ è‡ªå‹•ä½œæˆ</div>
                <div class="tab" onclick="setMode('manual')" id="tabManual">ğŸ‘† æ‰‹å‹•ä½œæˆ</div>
            </div>

            <!-- è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰è¨­å®š -->
            <div id="magicSettings">
                <label>éš™é–“åŸ‹ã‚å¼·åº¦ (ç·šã®å¤ªã‚‰ã›) <span id="dilationVal" class="slider-val">2</span></label>
                <input type="range" id="dilationRange" min="0" max="10" value="2" oninput="updateDilation(this.value)">
                <p style="font-size:11px; color:#666; margin:0 0 10px;">â€»å€¤ã‚’ä¸Šã’ã‚‹ã¨å£ã®éš™é–“ã‚’ç„¡è¦–ã—ã¾ã™ãŒã€ç´°ã‹ã„é€šè·¯ãŒæ½°ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
            </div>

            <!-- å±æ€§ã‚¨ãƒ‡ã‚£ã‚¿ (ä½œæˆä¸­ & é¸æŠä¸­ å…±é€š) -->
            <div id="attributeEditor" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                <h3 id="editorTitle">æ–°è¦ã‚¨ãƒªã‚¢è¨­å®š</h3>
                
                <label>åç§°</label>
                <input type="text" id="roomName" placeholder="ä¾‹: 1-Aæ•™å®¤">

                <label>ç¨®é¡</label>
                <select id="roomType">
                    <option value="classroom">æ•™å®¤</option>
                    <option value="hallway">å»Šä¸‹</option>
                    <option value="entrance">å‡ºå…¥å£</option>
                    <option value="stairs">éšæ®µ</option>
                    <option value="restroom_m">ãƒˆã‚¤ãƒ¬(ç”·)</option>
                    <option value="restroom_f">ãƒˆã‚¤ãƒ¬(å¥³)</option>
                    <option value="other">ãã®ä»–</option>
                </select>

                <div id="stairInfo" class="hidden">
                    <label>æ¥ç¶šéš</label>
                    <input type="text" id="targetFloor" placeholder="ä¾‹: 2F">
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="input-group" id="createActions">
                    <button class="secondary" onclick="undoPoint()">æˆ»ã‚‹</button>
                    <button onclick="finishArea()">ç¢ºå®š</button>
                </div>
                <div class="input-group hidden" id="editActions">
                    <button onclick="updateSelectedArea()">å¤‰æ›´ã‚’ä¿å­˜</button>
                    <button class="danger" onclick="deleteSelectedArea()">å‰Šé™¤</button>
                </div>
                <div id="selectionHint" class="hidden" style="font-size:12px; color:#007bff; text-align:center; margin-top:5px;">
                    é ‚ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å½¢ã‚’ä¿®æ­£ã§ãã¾ã™
                </div>
            </div>

            <!-- ã‚¨ãƒªã‚¢ãƒªã‚¹ãƒˆ -->
            <label style="margin-top:15px;">ä½œæˆæ¸ˆã¿ã‚¨ãƒªã‚¢ä¸€è¦§</label>
            <div class="list-container" id="areaList"></div>
        </div>

        <!-- å‡ºåŠ› -->
        <div class="panel">
            <h3>3. ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›</h3>
            <button class="outline" onclick="exportJSON()">JSONã‚’ç”Ÿæˆãƒ»ã‚³ãƒ”ãƒ¼</button>
            <textarea id="jsonOutput" style="height: 60px;"></textarea>
        </div>
    </div>

<script>
    // --- å¤‰æ•°å®šç¾© ---
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let img = new Image();
    let areas = [];          // å…¨ã‚¨ãƒªã‚¢ãƒ‡ãƒ¼ã‚¿
    let currentPoints = [];  // ä½œæˆä¸­ã®é ‚ç‚¹
    let mode = 'magic';      // 'magic', 'manual', 'edit'
    
    let selectedAreaIndex = -1; // é¸æŠä¸­ã®ã‚¨ãƒªã‚¢ID
    let draggingPointIndex = -1; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®é ‚ç‚¹ID
    let collisionCanvas = null;  // éš™é–“åŸ‹ã‚ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹(éè¡¨ç¤º)

    // --- 1. åˆæœŸåŒ– & ç”»åƒèª­è¾¼ ---
    document.getElementById('imageLoader').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event){
            img.onload = function(){
                canvas.width = img.width;
                canvas.height = img.height;
                prepareCollisionMap(); // åˆ¤å®šç”¨åœ°å›³ã®ä½œæˆ
                draw();
            }
            img.src = event.target.result;
        }
    });

    // --- 2. éš™é–“å¯¾ç­– (Collision Map) ---
    function prepareCollisionMap() {
        if(!img.src) return;
        const val = parseInt(document.getElementById('dilationRange').value);
        
        // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
        const c = document.createElement('canvas');
        c.width = canvas.width;
        c.height = canvas.height;
        const cx = c.getContext('2d');
        
        // ç”»åƒã‚’æç”»
        cx.drawImage(img, 0, 0);
        
        // ç·šã‚’å¤ªã‚‰ã›ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ (ç°¡æ˜“è†¨å¼µå‡¦ç†)
        // canvasã®filteræ©Ÿèƒ½ã‚’ä½¿ã†ã®ãŒä¸€ç•ªé€Ÿã„ (blur + contrast)
        if (val > 0) {
            // ã¼ã‹ã—ã‚’å…¥ã‚Œã¦ã‹ã‚‰ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’æ¥µç«¯ã«ä¸Šã’ã¦2å€¤åŒ–ã™ã‚‹ã“ã¨ã§ã€Œå¤ªã‚‰ã›ã‚‹ã€
            cx.filter = `blur(${val/2}px) contrast(2000%) grayscale(100%) brightness(0.5)`; 
            // brightness0.5ã§é»’ã‚’å¼·èª¿ã€contrastã§å¢ƒç•Œã‚’ãƒ‘ã‚­ãƒƒã¨ã•ã›ã‚‹
            cx.drawImage(c, 0, 0); 
        } else {
            cx.filter = 'none';
            cx.drawImage(img, 0, 0);
        }
        
        collisionCanvas = c; // ä¿å­˜
    }

    function updateDilation(val) {
        document.getElementById('dilationVal').innerText = val;
        prepareCollisionMap();
    }

    // --- 3. ãƒã‚¦ã‚¹æ“ä½œ ---
    canvas.addEventListener('mousedown', function(e) {
        const pos = getPos(e);

        // A. ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ (é ‚ç‚¹ãƒ‰ãƒ©ãƒƒã‚°åˆ¤å®š)
        if (selectedAreaIndex !== -1) {
            const area = areas[selectedAreaIndex];
            // é ‚ç‚¹ã¨ã®å½“ãŸã‚Šåˆ¤å®š
            for(let i=0; i<area.points.length; i++) {
                const p = area.points[i];
                if (Math.hypot(p.x - pos.x, p.y - pos.y) < 10) {
                    draggingPointIndex = i;
                    return; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                }
            }
        }

        // B. æ–°è¦ä½œæˆ (æ‰‹å‹•)
        if (mode === 'manual') {
            currentPoints.push(pos);
            draw();
        }
        
        // C. æ–°è¦ä½œæˆ (è‡ªå‹•)
        else if (mode === 'magic') {
            // æ—¢å­˜ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é¸æŠã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            const clickedIdx = findAreaIndexAt(pos);
            if (clickedIdx !== -1) {
                selectArea(clickedIdx);
            } else {
                // ç©ºç™½ãªã‚‰è‡ªå‹•æ¤œå‡ºå®Ÿè¡Œ
                startMagicWand(pos);
            }
        }
        
        // D. é¸æŠ (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã ãŒé ‚ç‚¹ä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯)
        else if (mode === 'edit') {
             const clickedIdx = findAreaIndexAt(pos);
             if (clickedIdx !== -1) {
                 selectArea(clickedIdx);
             } else {
                 deselectArea(); // è§£é™¤
             }
        }
    });

    canvas.addEventListener('mousemove', function(e) {
        const pos = getPos(e);
        
        // é ‚ç‚¹ãƒ‰ãƒ©ãƒƒã‚°ä¸­
        if (draggingPointIndex !== -1 && selectedAreaIndex !== -1) {
            areas[selectedAreaIndex].points[draggingPointIndex] = pos;
            draw();
        } else {
            // ã‚«ãƒ¼ã‚½ãƒ«å¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯
            if (selectedAreaIndex !== -1) {
                const area = areas[selectedAreaIndex];
                const hit = area.points.some(p => Math.hypot(p.x - pos.x, p.y - pos.y) < 10);
                canvas.style.cursor = hit ? 'move' : 'default';
            }
        }
    });

    canvas.addEventListener('mouseup', function() {
        draggingPointIndex = -1;
    });

    canvas.addEventListener('dblclick', function(e) {
        if(mode === 'manual') {
            e.preventDefault();
            currentPoints.pop();
            finishArea();
        }
    });

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: Math.round((e.clientX - rect.left) * scaleX),
            y: Math.round((e.clientY - rect.top) * scaleY)
        };
    }

    // --- 4. è‡ªå‹•æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯ (Ray Casting on Collision Map) ---
    function startMagicWand(pos) {
        if (!collisionCanvas) prepareCollisionMap();
        const ctxCol = collisionCanvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const imageData = ctxCol.getImageData(0,0,w,h).data;

        function isWall(x, y) {
            if(x<0||x>=w||y<0||y>=h) return true;
            const idx = (y*w+x)*4;
            return imageData[idx] < 100; // é»’ã£ã½ã„ãªã‚‰å£
        }

        // æ”¾å°„çŠ¶ã«å£ã‚’æ¢ã™
        const rays = 72; 
        let points = [];
        for(let i=0; i<rays; i++) {
            const angle = (i/rays) * Math.PI * 2;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            for(let r=0; r<2000; r+=2) { // æœ€å¤§åŠå¾„
                const tx = Math.round(pos.x + cos * r);
                const ty = Math.round(pos.y + sin * r);
                if(isWall(tx, ty)) {
                    points.push({x:tx, y:ty});
                    break;
                }
            }
        }

        if(points.length > 10) {
            currentPoints = points; // ä»®ç¢ºå®š
            finishArea(); // ä¿å­˜ã—ã¦
            selectArea(areas.length - 1); // å³åº§ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸
        }
    }

    // --- 5. ã‚¨ãƒªã‚¢æ“ä½œ (ä¿å­˜ãƒ»é¸æŠãƒ»æ›´æ–°) ---
    
    function finishArea() {
        if(currentPoints.length < 3) return;
        
        // å…¥åŠ›å€¤å–å¾—
        const name = document.getElementById('roomName').value || `Area ${areas.length+1}`;
        const type = document.getElementById('roomType').value;
        const floor = document.getElementById('targetFloor').value;

        const newArea = {
            id: Date.now(),
            name: name,
            type: type,
            targetFloor: floor,
            points: [...currentPoints]
        };
        
        areas.push(newArea);
        currentPoints = [];
        
        // æ¬¡ã®ãŸã‚ã«åå‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼ˆé€£ç¶šå…¥åŠ›ã®åˆ©ä¾¿æ€§ï¼‰
        // ãŸã ã—IDã£ã½ã„æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ã¨è¦ªåˆ‡ã ãŒä»Šå›ã¯çœç•¥
        
        updateList();
        draw();
    }

    function selectArea(index) {
        selectedAreaIndex = index;
        mode = 'edit'; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸å¼·åˆ¶ç§»è¡Œ
        
        const area = areas[index];
        
        // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('roomName').value = area.name;
        document.getElementById('roomType').value = area.type;
        if(area.targetFloor) document.getElementById('targetFloor').value = area.targetFloor;
        
        // UIåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('editorTitle').innerText = "ã‚¨ãƒªã‚¢ç·¨é›†";
        document.getElementById('createActions').classList.add('hidden');
        document.getElementById('editActions').classList.remove('hidden');
        document.getElementById('selectionHint').classList.remove('hidden');
        
        // ãƒªã‚¹ãƒˆã®è¦‹ãŸç›®æ›´æ–°
        updateListUI();
        draw();
    }

    function deselectArea() {
        selectedAreaIndex = -1;
        // ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¿ãƒ–ã®çŠ¶æ…‹ã«æˆ»ã™
        mode = document.getElementById('tabMagic').classList.contains('active') ? 'magic' : 'manual';

        document.getElementById('editorTitle').innerText = "æ–°è¦ã‚¨ãƒªã‚¢è¨­å®š";
        document.getElementById('roomName').value = "";
        document.getElementById('createActions').classList.remove('hidden');
        document.getElementById('editActions').classList.add('hidden');
        document.getElementById('selectionHint').classList.add('hidden');
        
        updateListUI();
        draw();
    }

    function updateSelectedArea() {
        if(selectedAreaIndex === -1) return;
        const area = areas[selectedAreaIndex];
        area.name = document.getElementById('roomName').value;
        area.type = document.getElementById('roomType').value;
        area.targetFloor = document.getElementById('targetFloor').value;
        
        updateList();
        alert("å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    function deleteSelectedArea() {
        if(selectedAreaIndex === -1) return;
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            areas.splice(selectedAreaIndex, 1);
            deselectArea();
            updateList();
            draw();
        }
    }

    // --- 6. æç”» ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (img.src) ctx.drawImage(img, 0, 0);

        areas.forEach((area, idx) => {
            const isSelected = (idx === selectedAreaIndex);
            drawPolygon(area.points, getColor(area.type), true, isSelected);
            
            // ãƒ©ãƒ™ãƒ«æç”»
            const center = getCenter(area.points);
            ctx.fillStyle = "black";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText(area.name, center.x, center.y);

            // é¸æŠä¸­ã¯é ‚ç‚¹ã‚’æç”»
            if(isSelected) {
                area.points.forEach(p => {
                    ctx.fillStyle = 'white';
                    ctx.strokeStyle = '#007bff';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 5, 0, Math.PI*2); // ãƒãƒ³ãƒ‰ãƒ«
                    ctx.fill();
                    ctx.stroke();
                });
            }
        });

        // ä½œæˆä¸­
        if (currentPoints.length > 0) {
            drawPolygon(currentPoints, 'red', false, false);
        }
    }

    function drawPolygon(points, color, fill, highlight) {
        if(!points.length) return;
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for(let i=1; i<points.length; i++) ctx.lineTo(points[i].x, points[i].y);
        ctx.closePath();
        
        if(fill) {
            ctx.fillStyle = color;
            ctx.fill();
        }
        ctx.lineWidth = highlight ? 3 : 1;
        ctx.strokeStyle = highlight ? '#007bff' : '#666';
        ctx.stroke();
    }

    // --- 7. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function setMode(m) {
        deselectArea(); // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã¯é¸æŠè§£é™¤
        mode = m;
        document.getElementById('tabMagic').className = m === 'magic' ? 'tab active' : 'tab';
        document.getElementById('tabManual').className = m === 'manual' ? 'tab active' : 'tab';
        document.getElementById('magicSettings').style.display = m === 'magic' ? 'block' : 'none';
    }

    function updateList() {
        const list = document.getElementById('areaList');
        list.innerHTML = '';
        areas.forEach((area, idx) => {
            const div = document.createElement('div');
            div.className = 'list-item' + (idx === selectedAreaIndex ? ' selected' : '');
            div.innerText = `${area.name} (${area.type})`;
            div.onclick = () => selectArea(idx);
            list.appendChild(div);
        });
    }
    
    function updateListUI() { updateList(); } // åˆ¥åå‚ç…§

    function findAreaIndexAt(pos) {
        // ãƒãƒªã‚´ãƒ³å†…åˆ¤å®š (Ray Castingæ³•)
        for(let i=areas.length-1; i>=0; i--) { // ä¸Šã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰åˆ¤å®š
            const poly = areas[i].points;
            let inside = false;
            for (let j = 0, k = poly.length - 1; j < poly.length; k = j++) {
                const xi = poly[j].x, yi = poly[j].y;
                const xj = poly[k].x, yj = poly[k].y;
                const intersect = ((yi > pos.y) !== (yj > pos.y)) && (pos.x < (xj - xi) * (pos.y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            if(inside) return i;
        }
        return -1;
    }

    function getColor(type) {
        const map = {
            'classroom': 'rgba(76, 175, 80, 0.5)',
            'hallway': 'rgba(255, 193, 7, 0.5)',
            'entrance': 'rgba(33, 150, 243, 0.5)',
            'stairs': 'rgba(156, 39, 176, 0.5)',
            'restroom_m': 'rgba(63, 81, 181, 0.6)',
            'restroom_f': 'rgba(233, 30, 99, 0.6)'
        };
        return map[type] || 'rgba(158, 158, 158, 0.5)';
    }

    function getCenter(points) {
        let x=0, y=0;
        points.forEach(p=>{x+=p.x; y+=p.y;});
        return {x:x/points.length, y:y/points.length};
    }

    window.undoPoint = () => { currentPoints.pop(); draw(); };
    window.exportJSON = () => { 
        const json = JSON.stringify(areas.map(({id,...r})=>r), null, 2);
        document.getElementById('jsonOutput').value = json;
        navigator.clipboard.writeText(json).then(()=>alert("JSONã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
    };
    
    // éšæ®µå±æ€§ã®è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('roomType').addEventListener('change', (e) => {
        document.getElementById('stairInfo').classList.toggle('hidden', e.target.value !== 'stairs');
    });

</script>
</body>
</html>
