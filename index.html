<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒ—åº§æ¨™ã‚¨ãƒ‡ã‚£ã‚¿ v3.0 (è‡ªå‹•ãƒˆãƒ¬ãƒ¼ã‚¹)</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; display: flex; gap: 20px; padding: 20px; background-color: #f0f2f5; height: 95vh; box-sizing: border-box;}
        #canvas-wrapper { position: relative; border: 2px solid #ccc; overflow: auto; flex-grow: 1; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center;}
        canvas { cursor: crosshair; display: block; }
        #sidebar { width: 340px; display: flex; flex-direction: column; gap: 10px; height: 100%; min-width: 340px; }
        .controls { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; color: #333; }
        
        /* UI Elements */
        input[type="text"], select, button, input[type="file"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;}
        button { background-color: #007bff; color: white; cursor: pointer; border: none; font-weight: bold; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.magic { background-color: #6610f2; color: white; } /* é­”æ³•ã®æ–ç”¨ */
        button.danger { background-color: #dc3545; }
        
        .input-group { display: flex; gap: 5px; margin-bottom: 5px;}
        .input-group button { width: auto; flex-grow: 1; }
        
        .mode-switch { display: flex; gap: 0; margin-bottom: 10px; border: 1px solid #007bff; border-radius: 4px; overflow: hidden;}
        .mode-switch button { margin: 0; border-radius: 0; background: white; color: #007bff; border: none; border-right: 1px solid #007bff;}
        .mode-switch button.active { background: #007bff; color: white; }
        .mode-switch button:last-child { border-right: none; }

        textarea { width: 100%; height: 120px; font-family: monospace; font-size: 11px; border: 1px solid #ccc; resize: vertical;}
        .point-list { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; background: white; border-radius: 8px; padding: 5px;}
        .point-item { display: flex; justify-content: space-between; align-items: center; font-size: 12px; padding: 6px; border-bottom: 1px solid #f0f0f0; }
        .point-item:hover { background-color: #f8f9fa; }
        
        .hidden { display: none; }
        small { color: #666; display: block; margin-bottom: 5px; line-height: 1.4; }
    </style>
</head>
<body>

    <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¨ãƒªã‚¢ -->
    <div id="canvas-wrapper">
        <canvas id="mapCanvas"></canvas>
    </div>

    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <div id="sidebar">
        <div class="controls">
            <h3>1. ç”»åƒèª­è¾¼</h3>
            <input type="file" id="imageLoader" accept="image/*, .svg">
        </div>

        <div class="controls">
            <h3>2. ä½œæˆãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="mode-switch">
                <button id="modeManual" class="active" onclick="setMode('manual')">æ‰‹å‹•ãƒãƒãƒãƒ</button>
                <button id="modeMagic" onclick="setMode('magic')">ğŸª„ è‡ªå‹•æ¤œå‡º</button>
            </div>
            <small id="msgManual">ã‚¯ãƒªãƒƒã‚¯ã§ç‚¹ã‚’è¿½åŠ ã€ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºå®šã€‚</small>
            <small id="msgMagic" class="hidden">éƒ¨å±‹ã®å†…éƒ¨ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€é»’ã„æ ç·šã‚’è‡ªå‹•èªè­˜ã—ã¦ã‚¨ãƒªã‚¢åŒ–ã—ã¾ã™ã€‚</small>

            <label>å±æ€§:
                <select id="roomType">
                    <option value="classroom">æ•™å®¤</option>
                    <option value="hallway">å»Šä¸‹</option>
                    <option value="entrance">å‡ºå…¥å£</option>
                    <option value="stairs">éšæ®µ</option>
                    <option value="restroom_m">ãƒˆã‚¤ãƒ¬(ç”·)</option>
                    <option value="restroom_f">ãƒˆã‚¤ãƒ¬(å¥³)</option>
                    <option value="other">ãã®ä»–</option>
                </select>
            </label>
            <div id="stairInfo" class="hidden">
                <input type="text" id="targetFloor" placeholder="æ¥ç¶šéš (ä¾‹: 2F)">
            </div>
            <input type="text" id="roomName" placeholder="åç§° (ä¾‹: 1-A)">

            <div class="input-group" id="manualControls">
                <button class="secondary" onclick="undoPoint()">1ã¤æˆ»ã‚‹</button>
                <button onclick="manualFinish()">å®Œäº†</button>
            </div>
        </div>

        <div class="point-list" id="areaList"></div>

        <div class="controls">
            <h3>3. å‡ºåŠ›</h3>
            <div class="input-group">
                <button onclick="exportJSON()">JSONç”Ÿæˆ</button>
                <button class="danger" onclick="clearAll()">å…¨å‰Šé™¤</button>
            </div>
            <textarea id="jsonOutput"></textarea>
        </div>
    </div>

<script>
    // --- è¨­å®šãƒ»å¤‰æ•° ---
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true }); // ãƒ”ã‚¯ã‚»ãƒ«æ“ä½œç”¨æœ€é©åŒ–
    let img = new Image();
    let areas = [];
    let currentPoints = [];
    let currentMode = 'manual'; // 'manual' or 'magic'
    
    // --- 1. ç”»åƒèª­ã¿è¾¼ã¿ & åˆæœŸåŒ– ---
    document.getElementById('imageLoader').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();

        // SVGã‚‚ç”»åƒã¨ã—ã¦èª­ã¿è¾¼ã‚€ï¼ˆãƒ”ã‚¯ã‚»ãƒ«è§£æã™ã‚‹ãŸã‚ï¼‰
        if (file.type.includes("svg")) {
            reader.readAsDataURL(file); // SVGã‚’DataURLã¨ã—ã¦èª­ã¿è¾¼ã¿ã€Imageã¨ã—ã¦æç”»
        } else {
            reader.readAsDataURL(file);
        }

        reader.onload = function(event){
            img.onload = function(){
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã‚‹
                canvas.width = img.width;
                canvas.height = img.height;
                draw();
            }
            img.src = event.target.result;
        }
    });

    // --- 2. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒ»UIåˆ¶å¾¡ ---
    window.setMode = function(mode) {
        currentMode = mode;
        document.getElementById('modeManual').className = mode === 'manual' ? 'active' : '';
        document.getElementById('modeMagic').className = mode === 'magic' ? 'active' : '';
        
        document.getElementById('msgManual').style.display = mode === 'manual' ? 'block' : 'none';
        document.getElementById('msgMagic').style.display = mode === 'magic' ? 'block' : 'none';
        document.getElementById('manualControls').style.display = mode === 'manual' ? 'flex' : 'none';
        
        currentPoints = []; // åˆ‡ã‚Šæ›¿ãˆæ™‚ã«ä½œæˆä¸­ã®ç‚¹ã¯ãƒªã‚»ãƒƒãƒˆ
        draw();
    }

    document.getElementById('roomType').addEventListener('change', (e) => {
        document.getElementById('stairInfo').style.display = e.target.value === 'stairs' ? 'block' : 'none';
    });

    // --- 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© (ã‚¯ãƒªãƒƒã‚¯å‡¦ç†) ---
    canvas.addEventListener('mousedown', async function(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);

        if (currentMode === 'manual') {
            // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ï¼šç‚¹ã‚’æ‰“ã¤
            currentPoints.push({x, y});
            draw();
        } else if (currentMode === 'magic') {
            // è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ï¼šå¡—ã‚Šã¤ã¶ã—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç™ºå‹•
            detectAreaByFill(x, y);
        }
    });

    canvas.addEventListener('dblclick', function(e) {
        if(currentMode === 'manual') {
            e.preventDefault();
            currentPoints.pop(); // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ä½™è¨ˆãªç‚¹ã‚’å‰Šé™¤
            saveArea();
        }
    });

    // --- 4. è‡ªå‹•æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (Marching Squares / Flood Fill ç°¡æ˜“ç‰ˆ) ---
    function detectAreaByFill(startX, startY) {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const w = canvas.width;
        const h = canvas.height;

        // ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã®è‰²ï¼ˆèƒŒæ™¯è‰²ï¼‰ã‚’å–å¾—
        const startIdx = (startY * w + startX) * 4;
        const bgR = data[startIdx], bgG = data[startIdx+1], bgB = data[startIdx+2];

        // è‰²ãŒã€Œå£ï¼ˆé»’ã£ã½ã„è‰²ï¼‰ã€ã«è¿‘ã„ã‹åˆ¤å®šã™ã‚‹é–¢æ•°
        function isWall(idx) {
            // RGBãŒã™ã¹ã¦æš—ã„ï¼ˆé–¾å€¤100ä»¥ä¸‹ï¼‰ãªã‚‰å£ã¨ã¿ãªã™ç°¡æ˜“åˆ¤å®š
            // â€»ç‚¹ç·šã‚„è–„ã„ç·šã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å³å¯†ãªé»’(0)ã§ãªãã¦ã‚‚åå¿œã•ã›ã‚‹
            const r = data[idx], g = data[idx+1], b = data[idx+2];
            return (r < 180 && g < 180 && b < 180); 
        }

        // BFS (å¹…å„ªå…ˆæ¢ç´¢) ã§é ˜åŸŸã‚’å¡—ã‚Šã¤ã¶ã—ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        const visited = new Uint8Array(w * h); // è¨ªå•æ¸ˆã¿ãƒ•ãƒ©ã‚°
        const stack = [startX, startY];
        let minX=w, maxX=0, minY=h, maxY=0;
        const areaPixels = []; // é ˜åŸŸå†…ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ç¾¤

        // å®‰å…¨è£…ç½®: å‡¦ç†ãŒé‡ããªã‚Šã™ããªã„ã‚ˆã†åˆ¶é™
        let count = 0;
        const limit = w * h * 0.8; 

        while(stack.length > 0 && count < limit) {
            const cy = stack.pop();
            const cx = stack.pop();
            const idx = (cy * w + cx);

            if (visited[idx]) continue;
            visited[idx] = 1;
            count++;

            // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ›´æ–°
            if(cx < minX) minX = cx; if(cx > maxX) maxX = cx;
            if(cy < minY) minY = cy; if(cy > maxY) maxY = cy;
            
            // å¤–å‘¨æŠ½å‡ºã®ãŸã‚ã«ä¿å­˜ï¼ˆå®Ÿéš›ã¯å…¨ãƒ”ã‚¯ã‚»ãƒ«ä¿å­˜ã¯é‡ã„ã®ã§ã€ç«¯ç‚¹ã®ã¿æ¢ã‚‹ã®ãŒåŠ¹ç‡çš„ã ãŒã€ä»Šå›ã¯ç°¡æ˜“å®Ÿè£…ï¼‰
            
            // 4æ–¹å‘æ¢ç´¢
            const neighbors = [[0,1], [0,-1], [1,0], [-1,0]];
            for(let [dx, dy] of neighbors) {
                const nx = cx + dx, ny = cy + dy;
                if (nx >= 0 && nx < w && ny >= 0 && ny < h) {
                    const nIdx = (ny * w + nx);
                    const pIdx = nIdx * 4;
                    if (!visited[nIdx] && !isWall(pIdx)) {
                         stack.push(nx, ny);
                    }
                }
            }
        }

        // å¢ƒç•Œç·šã®æŠ½å‡ºï¼ˆãƒãƒ¼ãƒãƒ³ã‚°ã‚¹ã‚¯ã‚¨ã‚¢ç°¡æ˜“ç‰ˆ: Convex Hullã ã¨å‡¹ã¿ãŒå–ã‚Œãªã„ã®ã§ã€ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ³æ³•ã§è¼ªéƒ­ã‚’å–ã‚‹ï¼‰
        // ã“ã“ã§ã¯ã€Œå¾—ã‚‰ã‚ŒãŸé ˜åŸŸã®å¤–æ¥çŸ©å½¢å†…ã®å£ãƒ”ã‚¯ã‚»ãƒ«ã€ã‚’å˜ç´”åŒ–ã—ã¦æ‹¾ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚Šã¾ã™ã€‚
        
        // éå¸¸ã«ç°¡æ˜“ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: 
        // 1. æ¢ç´¢ç¯„å›²(minX~maxX, minY~maxY)ã®å°‘ã—å¤–å´ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã€
        //    ã€Œå¡—ã‚Šã¤ã¶ã—é ˜åŸŸã€ã«éš£æ¥ã—ã¦ã„ã‚‹ã€Œå£ã€ãƒ”ã‚¯ã‚»ãƒ«ã‚’åé›†ã™ã‚‹ã€‚
        const contourPoints = [];
        
        // ä¸Šè¨˜BFSã¯é‡ã„ãŸã‚ã€å®Ÿç”¨çš„ãªã€Œã‚¯ãƒªãƒƒã‚¯åœ°ç‚¹ã‹ã‚‰æ”¾å°„çŠ¶ã«å£ã‚’æ¢ã™ã€Ray castingæ³•ã«å¤‰æ›´
        // (è¤‡é›‘ãªå½¢çŠ¶ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å¤šè§’å½¢è¿‘ä¼¼ã‚’è¡Œã„ã¾ã™)
        
        const rays = 72; // 360åº¦ã‚’ä½•åˆ†å‰²ã™ã‚‹ã‹ï¼ˆå¤šã„ã»ã©æ»‘ã‚‰ã‹ï¼‰
        const polygon = [];
        
        for(let i=0; i<rays; i++) {
            const angle = (i / rays) * Math.PI * 2;
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            
            let dist = 0;
            let hit = false;
            // æœ€å¤§åŠå¾„ã¾ã§é£›ã°ã™
            for(let r=0; r<Math.max(w,h); r+=2) { // 2pxåˆ»ã¿ã§é«˜é€ŸåŒ–
                const tx = Math.round(startX + cos * r);
                const ty = Math.round(startY + sin * r);
                
                if(tx<0||tx>=w||ty<0||ty>=h) break; // ç”»é¢å¤–
                
                const idx = (ty * w + tx) * 4;
                if(isWall(idx)) {
                    polygon.push({x: tx, y: ty});
                    hit = true;
                    break;
                }
            }
        }

        // ç‚¹ãŒå°‘ãªã™ãã‚‹ã€ã¾ãŸã¯é¢ç©ãŒå°ã•ã™ãã‚‹å ´åˆã¯ç„¡è¦–
        if(polygon.length < 3) {
            alert("å£ã§å›²ã¾ã‚ŒãŸé ˜åŸŸã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ»ç·šãŒé€”åˆ‡ã‚Œã¦ã„ã‚‹\nãƒ»è‰²ãŒè–„ã™ãã‚‹\nå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚");
            return;
        }

        // æ¤œå‡ºã•ã‚ŒãŸç‚¹ç¾¤ã‚’ã‚¨ãƒªã‚¢ã¨ã—ã¦ç¢ºå®š
        // â€»ç‚¹ç¾¤ãŒå¤šã„ã®ã§é–“å¼•ãå‡¦ç†ã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„ãŒã€JSONã‚µã‚¤ã‚ºãŒè¨±ã™ãªã‚‰ãã®ã¾ã¾
        currentPoints = polygon;
        saveArea();
    }

    // --- 5. ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»æç”» ---
    function saveArea() {
        if (currentPoints.length < 3) return;
        
        const type = document.getElementById('roomType').value;
        const name = document.getElementById('roomName').value || `Area_${areas.length + 1}`;
        let extra = type === 'stairs' ? {targetFloor: document.getElementById('targetFloor').value} : {};
        
        areas.push({
            id: Date.now(),
            name: name,
            type: type,
            ...extra,
            points: [...currentPoints]
        });
        
        currentPoints = [];
        // æ¬¡ã®å…¥åŠ›ã®ãŸã‚ã«åå‰æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ãªã„ï¼ˆé€£ç•ªå…¥åŠ›ãªã©ã‚’æƒ³å®šï¼‰
        // document.getElementById('roomName').value = ''; 
        
        updateList();
        draw();
    }

    function manualFinish() { saveArea(); }
    function undoPoint() { currentPoints.pop(); draw(); }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (img.src) ctx.drawImage(img, 0, 0);

        // ç¢ºå®šæ¸ˆã¿ã‚¨ãƒªã‚¢
        areas.forEach(area => {
            drawPoly(area.points, getColor(area.type), true);
            drawLabel(area);
        });

        // ä½œæ¥­ä¸­ã‚¨ãƒªã‚¢
        if (currentPoints.length > 0) {
            drawPoly(currentPoints, 'red', currentMode === 'magic'); // magicãƒ¢ãƒ¼ãƒ‰ãªã‚‰é–‰ã˜ã‚‹
            currentPoints.forEach(p => {
                ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            });
        }
    }

    function drawPoly(pts, color, fill) {
        if(!pts.length) return;
        ctx.beginPath();
        ctx.moveTo(pts[0].x, pts[0].y);
        for(let i=1; i<pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
        if(fill) {
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }
        ctx.strokeStyle = fill ? '#333' : color;
        ctx.lineWidth = 2;
        ctx.stroke();
    }

    function drawLabel(area) {
        // é‡å¿ƒè¨ˆç®—
        let x=0, y=0;
        area.points.forEach(p=>{x+=p.x; y+=p.y;});
        const cx = x/area.points.length, cy = y/area.points.length;
        
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        const text = area.name;
        const w = ctx.measureText(text).width;
        ctx.fillRect(cx - w/2 - 2, cy - 10, w+4, 14);
        
        ctx.fillStyle = "black";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(text, cx, cy);
    }

    function getColor(type) {
        const map = {
            'classroom': '#4CAF5066', 'hallway': '#FFC10766', 'entrance': '#2196F366', 
            'stairs': '#9C27B066', 'restroom_m': '#3F51B580', 'restroom_f': '#E91E6380'
        };
        return map[type] || '#9E9E9E66';
    }

    // --- 6. ãƒªã‚¹ãƒˆç®¡ç†ãƒ»å‡ºåŠ› ---
    function updateList() {
        const list = document.getElementById('areaList');
        list.innerHTML = '';
        areas.forEach((a, i) => {
            const d = document.createElement('div');
            d.className = 'point-item';
            d.innerHTML = `<b>${a.name}</b> <button class="danger" onclick="delArea(${i})">Ã—</button>`;
            list.appendChild(d);
        });
    }
    window.delArea = (i) => { areas.splice(i,1); updateList(); draw(); };
    window.clearAll = () => { if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")){ areas=[]; draw(); updateList(); }};
    window.exportJSON = () => { document.getElementById('jsonOutput').value = JSON.stringify(areas.map(({id,...r})=>r), null, 2); };

</script>
</body>
</html>
